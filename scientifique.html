<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CalcPro iOS 26 + ANS + +/- + Scroll Historique</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;}
body{margin:0;height:100vh;display:flex;justify-content:center;align-items:flex-end;background:radial-gradient(circle at top,#111,#000);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;color:white;padding-bottom:20px;}
.calculator{
  width:380px;padding:22px;border-radius:42px;
  background:linear-gradient(180deg,rgba(255,255,255,0.08),rgba(255,255,255,0.02));
  backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);
  box-shadow:0 50px 100px rgba(0,0,0,.9),inset 0 1px 1px rgba(255,255,255,.15);
  display:flex;flex-direction:column;
  transition: backdrop-filter 0.2s ease;
}
.display{
  background:rgba(255,255,255,0.06);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-radius:26px;padding:18px;font-size:34px;color:#22c55e;
  text-align:right;min-height:70px;letter-spacing:0.6px;font-variant-numeric:tabular-nums;
  box-shadow:inset 0 1px 1px rgba(255,255,255,.2);overflow:hidden;position:relative;
  margin-bottom:10px;
}
.display span{
  display:inline-block;
  transform:translateY(-100%);
  opacity:0;
  transition: transform 0.15s cubic-bezier(.25,.8,.25,1), opacity 0.15s;
}
.display.show span{
  transform:translateY(0);
  opacity:1;
}
.history{
  font-size:13px;color:#aaa;max-height:150px;overflow-y:auto;margin-bottom:10px;
}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
button{border:none;border-radius:50%;padding:18px;font-size:18px;cursor:pointer;background:rgba(255,255,255,0.08);color:white;box-shadow:0 10px 25px rgba(0,0,0,.6),inset 0 1px 1px rgba(255,255,255,.15);transition:transform .12s cubic-bezier(.2,.8,.2,1),filter .12s,box-shadow .12s;}
button:active{transform:scale(.9);filter:brightness(1.25);box-shadow:0 3px 10px rgba(0,0,0,.9),inset 0 2px 4px rgba(0,0,0,.4);}
.func{color:#38bdf8}
.op{background:#ff9500}
.equal{background:#34c759;grid-column:span 2;border-radius:30px;}
.ans{background:#8b5cf6;}
.sign{background:#f43f5e;}
</style>
</head>
<body>
<div class="calculator" id="calc">
  <div class="display" id="display"><span>0</span></div>
  <div class="history" id="history"></div>

  <div class="grid">
    <button class="func" onclick="add('√(')">√</button>
    <button class="func" onclick="add('sin(')">sin</button>
    <button class="func" onclick="add('cos(')">cos</button>
    <button class="func" onclick="add('tan(')">tan</button>
    <button class="func" onclick="add('ln(')">ln</button>
    <button class="func" onclick="add('log(')">log</button>
    <button class="func" onclick="add('π')">π</button>
    <button class="func" onclick="add('e')">e</button>
    <button class="func" onclick="add('^')">xʸ</button>
    <button class="op" id="delBtn" onclick="deleteOrClear()">AC</button>

    <button onclick="add('7')">7</button>
    <button onclick="add('8')">8</button>
    <button onclick="add('9')">9</button>
    <button class="op" onclick="add('+')">+</button>
    <button class="op" onclick="add('−')">−</button>

    <button onclick="add('4')">4</button>
    <button onclick="add('5')">5</button>
    <button onclick="add('6')">6</button>
    <button class="op" onclick="add('×')">×</button>
    <button class="op" onclick="add('÷')">÷</button>

    <button onclick="add('1')">1</button>
    <button onclick="add('2')">2</button>
    <button onclick="add('3')">3</button>
    <button class="op" onclick="add('(')">(</button>
    <button class="op" onclick="add(')')">)</button>

    <button onclick="add('0')">0</button>
    <button onclick="add('.')">.</button>
    <button class="ans" onclick="addANS()">ANS</button>
    <button class="sign" onclick="toggleSign()">+/-</button>
    <button class="equal" onclick="calculate()">=</button>
  </div>
</div>

<script>
let display=document.getElementById("display");
let history=document.getElementById("history");
let delBtn=document.getElementById("delBtn");
let calc=document.getElementById("calc");
let input="";
let lastResult=0;

function animateDigits(str){
  display.innerHTML="";
  display.classList.remove("show");
  for(let i=0;i<str.length;i++){
    let span=document.createElement("span");
    span.innerText=str[i];
    display.appendChild(span);
    setTimeout(()=>{span.style.transform="translateY(0)";span.style.opacity=1;},0);
  }
  display.classList.add("show");
  let blurValue = 20 + Math.min(str.length*2,30);
  calc.style.backdropFilter=`blur(${blurValue}px)`;
}

function updateDelButton(){delBtn.innerText=input?"⌫":"AC";}
function add(v){if(input==="0")input="";input+=v;animateDigits(input);updateDelButton();}
function addANS(){add(lastResult.toString());}
function deleteOrClear(){if(input.length>1){input=input.slice(0,-1);animateDigits(input);}else{input="";animateDigits("0");}updateDelButton();}

// toggle +/- iPhone style complet
function toggleSign(){
  if(!input && lastResult!==0){
    lastResult=-lastResult;
    animateDigits(lastResult.toString());
    return;
  }
  let regex=/(\d+(\.\d+)?)(?!.*\d)/;
  let match=input.match(regex);
  if(match){
    let number=match[1];
    let start=match.index;
    let inverted = number.startsWith("-") ? number.slice(1) : "-"+number;
    input = input.slice(0,start) + inverted + input.slice(start+number.length);
    animateDigits(input);
  }
}

// moteur math sécurisé
function calculate(){
  if(!input) return;
  try{
    let expr=input
      .replace(/π/g, Math.PI)
      .replace(/e/g, Math.E)
      .replace(/√/g,"sqrt")
      .replace(/×/g,"*")
      .replace(/÷/g,"/")
      .replace(/−/g,"-");

    let tokens=tokenize(expr);
    let result=evaluate(tokens);
    history.innerHTML+=`<div>${input} = ${result}</div>`;
    // ✅ scroll automatique en bas
    history.scrollTop = history.scrollHeight;
    animateDigits(result);
    input=""; lastResult=result;
  }catch{animateDigits("Erreur"); input="";}
  updateDelButton();
}

// tokenizer + moteur
function tokenize(str){return str.match(/sqrt|sin|cos|tan|log|ln|\d+(\.\d+)?|\^|[()+\-*/]/g);}
function precedence(op){if(op==="+"||op==="-")return 1;if(op==="*"||op==="/")return 2;if(op==="^")return 3;return 0;}
function applyOp(a,op,b){if(op==="+")return a+b;if(op==="-")return a-b;if(op==="*")return a*b;if(op==="/")return a/b;if(op==="^")return Math.pow(a,b);}
function applyFunc(f,v){if(f==="sin")return Math.sin(v);if(f==="cos")return Math.cos(v);if(f==="tan")return Math.tan(v);if(f==="log")return Math.log10(v);if(f==="ln")return Math.log(v);if(f==="sqrt")return Math.sqrt(v);}
function evaluate(tokens){
  let values=[],ops=[];
  for(let i=0;i<tokens.length;i++){
    let t=tokens[i];
    if(!isNaN(t)){values.push(Number(t));}
    else if(["sin","cos","tan","log","ln","sqrt"].includes(t)){ops.push(t);}
    else if(t==="("){ops.push(t);}
    else if(t===")"){
      while(ops.length&&ops[ops.length-1]!=="("){let op=ops.pop();let val=values.pop();values.push(applyFunc(op,val));}ops.pop();
    }else{
      while(ops.length&&precedence(ops[ops.length-1])>=precedence(t)){let op=ops.pop();let b=values.pop();let a=values.pop();values.push(applyOp(a,op,b));}
      ops.push(t);
    }
  }
  while(ops.length){let op=ops.pop();let b=values.pop();let a=values.pop();values.push(applyOp(a,op,b));}
  return values[0];
}

updateDelButton();
</script>
</body>
</html>
