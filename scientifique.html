<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CalcPro iOS 26 Sans Eval</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;}
body{margin:0;height:100vh;display:flex;justify-content:center;align-items:center;background:radial-gradient(circle at top,#111,#000);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;color:white;}
.calculator{width:380px;padding:22px;border-radius:42px;background:linear-gradient(180deg,rgba(255,255,255,0.08),rgba(255,255,255,0.02));backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);box-shadow:0 50px 100px rgba(0,0,0,.9),inset 0 1px 1px rgba(255,255,255,.15);}
.display{background:rgba(255,255,255,0.06);backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);border-radius:26px;padding:18px;font-size:34px;color:#22c55e;text-align:right;min-height:70px;letter-spacing:0.6px;font-variant-numeric:tabular-nums;box-shadow:inset 0 1px 1px rgba(255,255,255,.2);overflow:hidden;position:relative;}
.display span{display:inline-block;transition:transform 0.2s cubic-bezier(.25,.8,.25,1);}
.history{font-size:13px;color:#aaa;margin-bottom:10px;max-height:90px;overflow-y:auto;}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:15px;}
button{border:none;border-radius:50%;padding:18px;font-size:18px;cursor:pointer;background:rgba(255,255,255,0.08);color:white;box-shadow:0 10px 25px rgba(0,0,0,.6),inset 0 1px 1px rgba(255,255,255,.15);transition:transform .12s cubic-bezier(.2,.8,.2,1),filter .12s,box-shadow .12s;}
button:active{transform:scale(.9);filter:brightness(1.25);box-shadow:0 3px 10px rgba(0,0,0,.9),inset 0 2px 4px rgba(0,0,0,.4);}
.func{color:#38bdf8}
.op{background:#ff9500}
.equal{background:#34c759;grid-column:span 2;border-radius:30px;}
</style>
</head>

<body>
<div class="calculator">
  <div class="history" id="history"></div>
  <div class="display" id="display"><span>0</span></div>

  <div class="grid">
    <button class="func" onclick="add('√(')">√</button>
    <button class="func" onclick="add('sin(')">sin</button>
    <button class="func" onclick="add('cos(')">cos</button>
    <button class="func" onclick="add('tan(')">tan</button>
    <button class="func" onclick="add('ln(')">ln</button>
    <button class="func" onclick="add('log(')">log</button>
    <button class="func" onclick="add('π')">π</button>
    <button class="func" onclick="add('e')">e</button>
    <button class="func" onclick="add('^')">xʸ</button>
    <button class="op" id="delBtn" onclick="deleteOrClear()">AC</button>

    <button onclick="add('7')">7</button>
    <button onclick="add('8')">8</button>
    <button onclick="add('9')">9</button>
    <button class="op" onclick="add('×')">×</button>
    <button class="op" onclick="add('−')">−</button>

    <button onclick="add('4')">4</button>
    <button onclick="add('5')">5</button>
    <button onclick="add('6')">6</button>
    <button class="op" onclick="add('×')">×</button>
    <button class="op" onclick="add('÷')">÷</button>

    <button onclick="add('1')">1</button>
    <button onclick="add('2')">2</button>
    <button onclick="add('3')">3</button>
    <button onclick="add('(')">(</button>
    <button onclick="add(')')">)</button>

    <button onclick="add('0')">0</button>
    <button onclick="add('.')">.</button>
    <button class="equal" onclick="calculate()">=</button>
  </div>
</div>

<script>
let display=document.getElementById("display");
let history=document.getElementById("history");
let delBtn=document.getElementById("delBtn");
let input="";
let lastResult=0;

// Animate display
function animateDigits(result){
  display.innerHTML="";
  let str=String(result);
  for(let i=0;i<str.length;i++){
    let span=document.createElement("span");
    span.innerText=str[i];
    span.style.transform="translateY(-50px)";
    display.appendChild(span);
    setTimeout(()=>{span.style.transform="translateY(0)";},i*50);
  }
}

// Buttons
function updateDelButton(){delBtn.innerText=input?"⌫":"AC";}
function add(v){if(input==="0")input="";input+=v;animateDigits(input);updateDelButton();}
function deleteOrClear(){if(input.length>1){input=input.slice(0,-1);animateDigits(input);}else{input="";animateDigits(0);}updateDelButton();}

// ===== MOTEUR MATH SANS EVAL =====
function calculate(){
  if(!input) return;
  try{
    let expr = input
      .replace(/π/g, Math.PI)
      .replace(/e/g, Math.E)
      .replace(/√/g, "sqrt")
      .replace(/×/g, "*")
      .replace(/÷/g, "/")
      .replace(/−/g, "-");

    let tokens = tokenize(expr);
    let result = evaluate(tokens);
    history.innerHTML+=`<div>${input} = ${result}</div>`;
    animateDigits(result);
    input=""; lastResult=result;
  }catch{
    animateDigits("Erreur"); input="";
  }
  updateDelButton();
}

// ===== TOKENIZER =====
function tokenize(str){
  return str.match(/sqrt|sin|cos|tan|log|ln|\d+(\.\d+)?|\^|[()+\-*/]/g);
}

// ===== PRIORITÉ =====
function precedence(op){if(op==="+"||op==="-")return 1;if(op==="*"||op==="/")return 2;if(op==="^")return 3;return 0;}

// ===== APPLY OPERATOR =====
function applyOp(a,op,b){if(op==="+")return a+b;if(op==="-")return a-b;if(op==="*")return a*b;if(op==="/")return a/b;if(op==="^")return Math.pow(a,b);}

// ===== APPLY FUNCTION =====
function applyFunc(func,value){if(func==="sin")return Math.sin(value);if(func==="cos")return Math.cos(value);if(func==="tan")return Math.tan(value);if(func==="log")return Math.log10(value);if(func==="ln")return Math.log(value);if(func==="sqrt")return Math.sqrt(value);}

// ===== ÉVALUATION SANS EVAL =====
function evaluate(tokens){
  let values=[],ops=[];
  for(let i=0;i<tokens.length;i++){
    let t=tokens[i];
    if(!isNaN(t)){values.push(Number(t));}
    else if(["sin","cos","tan","log","ln","sqrt"].includes(t)){ops.push(t);}
    else if(t==="("){ops.push(t);}
    else if(t===")"){
      while(ops.length&&ops[ops.length-1]!=="("){let op=ops.pop();let val=values.pop();values.push(applyFunc(op,val));}ops.pop();
    }else{
      while(ops.length&&precedence(ops[ops.length-1])>=precedence(t)){let op=ops.pop();let b=values.pop();let a=values.pop();values.push(applyOp(a,op,b));}
      ops.push(t);
    }
  }
  while(ops.length){let op=ops.pop();let b=values.pop();let a=values.pop();values.push(applyOp(a,op,b));}
  return values[0];
}

updateDelButton();
</script>
</body>
</html>
